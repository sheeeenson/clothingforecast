<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü—Ä–æ–≥–Ω–æ–∑ –æ–¥–µ–∂–¥—ã</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
  body { font-family: 'Inter', sans-serif; background-color: #fff; }
  .container { max-width: 600px; }
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5); display: flex;
    justify-content: center; align-items: center; z-index: 1000;
  }
  .modal-content {
    background-color: #fff; padding: 24px; border-radius: 12px;
    text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    animation: fadeIn 0.3s ease-out; color: #000;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }
</style>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>üëï</text></svg>">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>üß•</text></svg>">
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-white text-black">

<div class="container bg-white rounded-xl shadow-md p-6 md:p-10 text-center w-full text-black border border-black">
  <h1 class="text-3xl md:text-4xl font-bold mb-2">–ü—Ä–æ–≥–Ω–æ–∑ –æ–¥–µ–∂–¥—ã</h1>
  <p class="text-lg md:text-xl font-medium text-gray-500 mb-6">–¢–≤–æ–π —Å—Ç–∏–ª–∏—Å—Ç –≤ –º–∏—Ä–µ –ø–æ–≥–æ–¥—ã</p>

  <div id="mainContent" class="mt-8 text-left space-y-4">
    <div id="weatherDisplay" class="bg-white p-4 rounded-xl shadow-md flex items-center justify-between mb-6 border border-black opacity-0 transition-opacity duration-500">
      <h3 id="currentTemp" class="text-xl font-bold"></h3>
      <p id="weatherDesc" class="text-lg text-gray-500"></p>
    </div>

    <div id="outfitResult" class="bg-white rounded-2xl p-6 relative border border-black">
      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å —ç–º–æ–¥–∑–∏ -->
      <div id="loadingIndicator" class="absolute inset-0 flex flex-col items-center justify-center text-center transition-opacity duration-500 h-full">
        <span id="loadingEmoji" class="text-6xl mb-2 animate-bounce"></span>
        <span id="loadingText" class="text-xl text-black"></span>
      </div>
      <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
      <img id="outfitImage" src="https://placehold.co/500x500/000000/ffffff?text=–ù–∞–∂–º–∏—Ç–µ+–¥–ª—è+–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏" class="w-full h-auto object-contain rounded-lg shadow-md transition-opacity duration-500 opacity-0">
    </div>

    <div id="controls" class="opacity-0 transition-opacity duration-500">
      <div class="grid grid-cols-2 gap-4 mt-6 mb-6 text-black">
        <div>
          <label for="thermoSelect" class="block text-sm font-medium mb-1">–¢–µ—Ä–º–æ—Ä–µ–≥—É–ª—è—Ü–∏—è</label>
          <select id="thermoSelect" class="p-2 rounded-lg border border-black bg-white w-full text-center">
            <option value="cold" selected>–í–µ—á–Ω–æ –≤ –ø–æ–∏—Å–∫–∞—Ö —Ç–µ–ø–ª–∞</option>
            <option value="normal">–ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞</option>
            <option value="hot">–ü—Ä–æ—Ö–ª–∞–¥–∞ –º–Ω–µ –Ω–∏–ø–æ—á—ë–º</option>
          </select>
        </div>
        <div>
          <label for="genderSelect" class="block text-sm font-medium mb-1">–ü–æ–ª</label>
          <select id="genderSelect" class="p-2 rounded-lg border border-black bg-white w-full text-center">
            <option value="any" selected>–õ—é–±–æ–π</option>
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6 mb-6 text-black">
        <div>
          <label for="styleSelect" class="block text-sm font-medium mb-1">–°—Ç–∏–ª—å</label>
          <select id="styleSelect" class="p-2 rounded-lg border border-black bg-white w-full text-center">
            <option value="casual" selected>–ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–π</option>
            <option value="business">–î–µ–ª–æ–≤–æ–π</option>
            <option value="evening">–í–µ—á–µ—Ä–Ω–∏–π</option>
            <option value="sporty">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</option>
          </select>
        </div>
        <div>
          <label for="occasionSelect" class="block text-sm font-medium mb-1">–°–∏—Ç—É–∞—Ü–∏—è</label>
          <select id="occasionSelect" class="p-2 rounded-lg border border-black bg-white w-full text-center">
            <option value="city walk" selected>–ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É</option>
            <option value="cafe evening">–í–µ—á–µ—Ä –≤ –∫–∞—Ñ–µ</option>
            <option value="date night">–°–≤–∏–¥–∞–Ω–∏–µ</option>
            <option value="active leisure">–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö</option>
          </select>
        </div>
      </div>
      
      <div class="flex flex-col md:flex-row gap-2">
        <button id="generateLook" class="bg-white hover:bg-gray-100 text-black p-3 rounded-lg flex-1 transition-colors duration-200 border border-black">–°–æ–±—Ä–∞—Ç—å –ª—É–∫ –ø–æ –ø–æ–≥–æ–¥–µ</button>
      </div>
    </div>
    <div id="messageBox" class="mt-4 text-center text-red-400"></div>
  </div>
</div>

<script type="module">
let loadingInterval = null;

const loadingStates = [
  { emoji: '‚ú®', text: '–î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –º–∞–≥–∏–∏...' },
  { emoji: 'üß∏', text: '–ü—Ä–∏–¥—É–º—ã–≤–∞–µ–º —Å–∞–º—ã–π –º–∏–ª—ã–π –æ–±—Ä–∞–∑...' },
  { emoji: 'üëí', text: '–í—ã–±–∏—Ä–∞–µ–º —à–∞–ø–æ—á–∫—É, —á—Ç–æ–±—ã –±—ã–ª–æ —Ç–µ–ø–ª–æ...' },
  { emoji: '‚òï', text: '–ü–æ–¥–æ–∂–¥–∏, —è –∑–∞–≤–∞—Ä—é —á–∞–π...' },
  { emoji: 'üöÄ', text: '–ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–∫–µ—Ç—É –≤ –∫–æ—Å–º–æ—Å —Å—Ç–∏–ª—è!' },
  { emoji: 'üßö', text: '–î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞...' },
  { emoji: 'üåà', text: '–ò—â–µ–º —Ä–∞–¥—É–≥—É –¥–ª—è —Ç–≤–æ–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!' },
  { emoji: 'üëñ', text: '–ü–æ–¥–±–∏—Ä–∞–µ–º –¥–∂–∏–Ω—Å—ã –¥–ª—è —Ç–∞–Ω—Ü–µ–≤...' },
  { emoji: 'üëü', text: '–®–Ω—É—Ä—É–µ–º –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –¥–ª—è –ø—Ä–æ–±–µ–∂–∫–∏...' },
  { emoji: 'üï∫', text: '–î–µ–ª–∞–µ–º –≥—Ä–∞—Ü–∏–æ–∑–Ω—É—é –ø–æ–∑—É!' },
  { emoji: 'üåû', text: '–°–æ–ª–Ω—Ü–µ —É–ª—ã–±–∞–µ—Ç—Å—è!' },
  { emoji: 'üå¨Ô∏è', text: '–í–µ—Ç–µ—Ä –∑–∞–∫—Ä—É—á–∏–≤–∞–µ—Ç –∏–¥–µ—é!' },
  { emoji: 'üß•', text: '–í—ã–±–∏—Ä–∞–µ–º –ø–∞–ª—å—Ç–æ –ø–æ—Ç–µ–ø–ª–µ–µ...' },
  { emoji: 'üåßÔ∏è', text: '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–æ–Ω—Ç –Ω–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç—å...' },
  { emoji: 'üß£', text: '–ü–æ–¥–±–∏—Ä–∞–µ–º —à–∞—Ä—Ñ –∫ —Ç–≤–æ–µ–º—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é...' },
  { emoji: 'üß§', text: '–ò—â–µ–º –ø–µ—Ä—á–∞—Ç–∫–∏, —á—Ç–æ–±—ã —Ä—É–∫–∏ –Ω–µ –º—ë—Ä–∑–ª–∏...' },
  { emoji: 'üß¶', text: '–ü–æ–¥–±–∏—Ä–∞–µ–º –Ω–æ—Å–æ—á–∫–∏ –¥–ª—è —É—é—Ç–∞...' },
  { emoji: 'üëì', text: '–î–µ–ª–∞–µ–º –æ–±—Ä–∞–∑ —É–º–Ω–µ–µ...' },
  { emoji: 'üéí', text: '–ù–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–π —É–¥–æ–±–Ω—ã–π —Ä—é–∫–∑–∞–∫...' },
  { emoji: 'üëë', text: '–î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ –∫–æ—Ä–æ–ª–µ–≤—Å–∫–æ–≥–æ —à–∏–∫–∞!' }
];

const faviconStates = ['üëï', 'üëñ', 'üëü', 'üß•', 'üß¶'];
let faviconIndex = 0;

const displayMessage = msg => {
  const messageBox = document.getElementById('messageBox');
  messageBox.textContent = msg;
};

const generateLookHandler = async () => {
    const outfitImage = document.getElementById('outfitImage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const messageBox = document.getElementById('messageBox');
    
    outfitImage.style.opacity = '0';
    loadingIndicator.style.opacity = '1';
    messageBox.textContent = '';
    
    let stateIndex = 0;
    loadingInterval = setInterval(() => {
        const state = loadingStates[stateIndex];
        document.getElementById('loadingEmoji').textContent = state.emoji;
        document.getElementById('loadingText').textContent = state.text;
        stateIndex = (stateIndex + 1) % loadingStates.length;
    }, 1000);

    const thermoType = document.getElementById('thermoSelect').value;
    const gender = document.getElementById('genderSelect').value;
    const style = document.getElementById('styleSelect').value;
    const occasion = document.getElementById('occasionSelect').value;

    try {
        let lat, lon;
        if ("geolocation" in navigator) {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
            });
            lat = position.coords.latitude;
            lon = position.coords.longitude;
        } else {
            lat = 55.7558;
            lon = 37.6173;
        }

        const res = await fetch('/api/weather', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat, lon, thermoType, gender, style, occasion })
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
        }

        const data = await res.json();
        const { outfitImage: outfitUrl, weatherData } = data;
        
        document.getElementById('currentTemp').textContent = `${Math.round(weatherData.main.temp)}¬∞C`;
        document.getElementById('weatherDesc').textContent = `${weatherData.name}, ${weatherData.weather[0].description}`;

        document.getElementById('outfitImage').src = `data:image/png;base64,${outfitUrl}`;

    } catch(e){
        document.getElementById('outfitImage').src = `https://placehold.co/500x500/000000/ffffff?text=–û—à–∏–±–∫–∞+–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏`;
        displayMessage(e.message); 
        console.error(e); 
    } finally {
        clearInterval(loadingInterval);
        loadingIndicator.style.opacity = '0';
        document.getElementById('outfitImage').style.opacity = '1';
    }
};

const initApp = async () => {
    document.getElementById('weatherDisplay').style.opacity = '1';
    document.getElementById('controls').style.opacity = '1';
    await generateLookHandler();
};

window.onload = () => {
  document.getElementById('generateLook').addEventListener('click', generateLookHandler);
  initApp();
  
  setInterval(() => {
    faviconIndex = (faviconIndex + 1) % faviconStates.length;
    const emoji = faviconStates[faviconIndex];
    document.getElementById('favicon').setAttribute('href', `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>${emoji}</text></svg>`);
  }, 1000);
};
</script>
</body>
</html>
